---
title: 'Simple ITK multi atlas registration and segmentation:  Methods and tutorials'
author: "Brian B. Avants"
date: "The University of Pennsylvania, Philadelphia, PA 19104."
bibliography:  references.bib
csl: national-science-foundation-grant-proposals.csl
output:
  pdf_document
geometry:  margin=1in
fontsize: 11pt
---

## Expected cost (include direct and indirect/overhead costs) for the proposed work.

Total cost = $99,995, Direct cost = $62,497, Indirect cost = $37,498

## Short description or abstract of the proposed work

We propose to augment Simple ITK with an integrated framework for
registration and segmentation of biomedical images.  Three components
will interact: (1) Scalable registration methods that employ point set
representations of *both* fixed and moving images will, for suitable
forms of data, allow accurate registration with reduced memory
footprint; (2) Registration methods will feed data into classical
prior-based image segmentation based on expectation-maximization
algorithms; (3) Registration methods will also initialize multi-atlas
methods, specifically the class of Joint Fusion multi-atlas
segmentation methods.  This contribution would extend the applicability
of the current ITK version 4 analysis framework to include full image
quantification pipelines that are appropriate for diverse application
areas such as template-based brain mapping or quantitative
high-resolution microscopy.  We will provide Simple ITK tutorials, unit
tests as well as the necessary JSON and other metadata needed for Simple
ITK bindings.

## Address of the Offering Institution.

Office of Research Services,  3451 Walnut Street, Suite P-221

Philadelphia PA 19104-6205

Email: PennAORS@lists.upenn.edu;  Phone Number: 215-746-0234;  Fax
Number: 215-898-9708

## List of all named personnel/investigators in the proposal

* Brian B. Avants, Ph.D., Department of Radiology, University of Pennsylvania.

* James C. Gee, Ph.D., Department of Radiology, University of Pennsylvania.

* Paul A. Yushkevich, Ph.D., Department of Radiology, University of Pennsylvania.

* Nicholas J. Tustison, D.Sc., Department of Radiology and Medical Imaging, University of Virginia (consultant).

# Technical Proposal

## Purpose of the proposed work

Two fundamental segmentation approaches in medical imaging are:

* Multi-atlas segmentation and
* Bayesian segmentation with priors (atlas-based or Markov Random Field (MRF) modeling).

Whereas the latter has a significant developmental history spanning 30+ years,
the former has seen extreme interest in the medical imaging community recently due to
the general success of crowdsourcing solutions to problems.  Although other
segmentation approaches are well-represented within the Insight Toolkit
and SimpleITK (e.g., region growing and level sets), these popular segmentation
approaches are glaringly absent.  This proposal aims to remedy this deficiency.

In addition, we propose to provide two complementary items to the Insight Toolkit
and SimpleITK:

* sparse registration
* spatially adaptive patch-based denoising.

Since image registration is a crucial prerequisite for both prior-based segmentation
approaches, the former serves to extend current ITK functionality to accommodate large
images (e.g., microscopy) in mapping spatial priors.  The latter will augment the
current patch-based denoising ITK framework for efficient data cleaning---another
crucial prerequisite for well-performing segmentation algorithms.

## Multi-atlas labeling

**Annotations and anatomical labelings are critical to the
interpretation and statistical analysis of biomedical images.** However
such expert labeling is both expensive and time consuming to obtain and
often out of reach for many institutions due to lack of local expertise
and/or funding to hire such expertise. However, libraries of expert
annotations are becoming available in ever increasing numbers. Expert
annotation on biomedical imaging may exist at different scales from
labeling cell types in histology to labeling microscopic structures in
optical images all the way up to millimeter or centimeter scale
neuroanatomy visible in magnetic resonance images.  These digital
annotations attached to biomedical images can take several hours to
several weeks or more in order to create.  Therefore, it is of critical
importance that the potential benefit of these resources is maximized.
This requires that such datasets are distributed along with powerful
open-source software that brings their value to as many researchers as
possible.

**Multi-atlas labeling (MAL)** is the current state of the art for
propagating expert labelings from a reference library onto new instances
of unlabeled data. The typical procedure for multiple atlas fusion
involves common steps regardless of the underlying method. These steps
include: (1) registration, (2) label transformation and (3) local
statistical prediction models.  The end product of this procedure is,
for a given new subject, the algorithmic "best guess" at the full
anatomical label set within the image. The quality of this guess differs
across algorithms and substantial effort has been invested in
identifying the state-of-the-art in MAL (see, for example, the recent
[MICCAI 2012 Grand Challenge and Workshop on Multi-Atlas Labeling](https://masi.vuse.vanderbilt.edu/workshop2012/index.php/Main_Page)).


**Joint Fusion (JF)** [@Wang:2012aa;@Wang:2013aa] is perhaps *the state-of-the-art
algorithm* for MAL that is capable of predicting anatomical labels with
accuracy that rivals expert anatomists [@Yushkevich:2010aa]. JF has proven its
effectiveness in lung [@Tustison:2015aa],
[cardiac data](https://masi.vuse.vanderbilt.edu/workshop2013/index.php/Main_Page),
the human brain [@Tustison:2014aa], and in
[multiple modality canine MRI](https://masi.vuse.vanderbilt.edu/workshop2013/index.php/Main_Page).
Currently this technology is available through an ITK-style C++ implementation
available within Advanced Normalization Tools (ANTs).  Its inclusion within
ANTs is sensible in that the success
of JF and related methods depends heavily upon high quality deformable
maps that transform the anatomical library image set into the target
subject's physical space.

**Patch-based Denoising** As part of the v4 round of ITK development, a patch-based
denoising framework was contributed based on the work described in [@Awate:2006aa;@Buades2008].
Such work is critical for data 'cleaning' prior to subsequent processing such
as segmentation or normalization.  More recently, an alternative approach to denoising
was proposed in [@Manjon:2010aa] which we implemented and put in ANTs.  This filter
performs well with limited parameter choices to consider and is also relatively
fast. We believe that this additional work would provide a much-needed complement to the
existing denoising framework as well as the segmentation tools proposed.  Similar to the
other tools discussed, a denoising application would be easily integrated into SimpleITK
and increase the functionality of the toolkit.

**This proposal will bring JF to the ITK and SimpleITK user community**.
 We will also document and promote the models with tutorial material
that will illustrate the application of JF to template based
segmentation of T1-weighted MRI of the brain. Furthermore, we will
support the successful and efficient application of JF to both standard
size and large datasets via novel improvements to the existing ITK
segmentation and registration frameworks.  For segmentation, we will add
a complete implementation of (spatial) prior-based statistical
segmentation via guassian mixture or non-parametric models.  This
framework will build upon existing ITK resource and will be extensible
with other likelihood models.  For registration, we will extend the
current framework with more memory efficient image data representations.
 This approach will build upon existing sub-sampling frameworks within
ITK version 4 registration to allow registration to be driven by a
sparse image representation.  This efficent data representation  will allow adaptive registration
strategies that can be customized for large datasets and will extend the
reach of these methods.

* Joint label fusion is a multi-atlas segmentation method.

* It performed well in several recent competitions ([SATA 2012, SATA
2013](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3837555/))

* We use it regularly in our studies to build template priors and to
label cortical or deep structures in the brain.

> The key difference between joint label fusion and other label fusion
> methods is that it explicitly considers correlations among atlases,
> i.e., the dependence matrix, into voting weight assignment to reduce
> bias in the atlas set.


**FIXME** stuff about sparse representation


**Simple ITK Integration**:  This proposal may appear ambitious given
the modest budget.  However, our proposal builds upon existing work
within ANTs to make these goals achievable.  Primarily, we will port the
near-ITK quality existing code into the ITK ecosystem for review by
other developers via the Gerrit code review system.  We are strongly
familiar with this system as the team members, particularly lead
developer Nicholas Tustison, regularly contribute to ITK.  Thus, the
effort, here, will follow a natural progression:

* Augment existing ANTs classes that implement prior-based and JF
segmentation with ITK-style tests;

* Pass these for review to Gerrit;

* Implement code refactoring/documentation requested by ITK core;

* Implement appropriate wrapping, documentation and metadata for Simple ITK.

Beyond these first steps, we will also (most importatly, perhaps)
implement step-by-step tutorial material based on the Simple ITK
platform.  We feel this is best illustrated with examples of
this tutorial material which follows here.

As mentioned previously, much of the functionality that we are proposing already
exists in an ITK-style format within ANTs.  Specifically, the following
segmentation-related filters exist within the current ANTs repository and would
be modified.

* MAP-MRF segmentation ITK-style classes (details found in [@Avants:2011aa]):
    * ``AtroposSegmentationImageFilter``
    * ``ListSampleFunction`` (parent class---sample probability estimation)
        * ``GaussianListSampleFunction``
        * ``HistogramParzenWindowsListSampleFunction``
        * ``JointHistogramParzenWindowsListSampleFunction``
        * ``JointHistogramParzenShapeAndOrientationListSampleFunction``
        * ``LogEuclideanGaussianListSampleFunction``
        * ``ManifoldParzenWindowsListSampleFunction``
        * ``PartialVolumeGaussianListSampleFunction``
    * ``ListSampleToListSampleFilter`` (parent class---outlier filtering)
        * ``BoxPlotQuantileListSampleFilter``
        * ``GrubbsRosnerListSampleFilter``
        * ``PassThroughListSampleFilter``

* Multivariate multi-atlas fusion (details found in [@Wang:2012aa;@Wang:2013aa]):
    * ``WeightedVotingFusionImageFilter``

* Patch-based denoising (details found in [@Manjon:2010aa]):
    * ``AdaptiveNonLocalMeansDenoisingImageFilter``

Although these filters are tested frequently within the ANTs framework, certain
improvements/modifications would be required before direct integration into the
ITK library such as the inclusion of ITK-specific testing protocols.


**FIXME Nick** can you add a section in appropriate location regarding sparse transformation models (and say what we already have for sparse metric possibilities - i think we need to skip the ICDM stuff --- too complex)


## Simple ITK tutorial material for JF-augmented brain mapping

We will employ freely available *real neuroimaging data* on which to
base the tutorial material and to promote reproducibility and
transparency. We will employ the Pediatric Template of Brain Perfusion
(PTBP) [at
figshare](http://figshare.com/articles/
The_Pediatric_Template_of_Brain_Perfusion_PTBP_/923555) which includes
free multiple modality MRI data with demographics and psychometrics. The
data is accompanied by an [organized csv
file](http://files.figshare.com/1699436/ptbp_summary_demographics.csv)
with full data available at
[figshare](http://figshare.com/articles/
The_Pediatric_Template_of_Brain_Perfusion_PTBP_/923555).  We will use a
lightly processed version of the data to make examples quick enough for "on the fly" tutorial material.

We will use the sample PTBP subjects to:

* *Tutorial 1:* Build a template based on deformable registration done in Simple ITK

* *Tutorial 2:* Construct template priors with [Joint
Fusion](http://www.ncbi.nlm.nih.gov/pubmed/22732662) and based on freely
available labeled data

* *Tutorial 3:* Normalize and segment the population data based on spatial prior-based
gaussian mixture modeling.

**FIXME** say some stuff about scripting and experience with ANTs MNI and ANTs USC and MICCAI and ITK tutorials ...

This will all be put together to create a reproducible analysis for a
subset of the PTBP. This material will be invaluable for better
introducing the neuroscience and larger biomedical image analysis
community to this broadly applicable and powerful quantification
technology. **FIXME** repeat technology again ...

## Relationship and benefits of the project to the SimpleITK/ITK effort

Registration and segmentation are complementary tools that have often
existed along independent software development paths.  Registration
teams rarely intersected with segmentation teams.  Joint Fusion and
related methods, however, serve as an integrative meta-algorithm which uses
components of both classic registration and classic segmentation to
improve upon the results obtained by either independently.  Making these
bleeding edge algorithms available to the ITK and Simple-ITK community
will break down barriers between "code aware" and "code naive" user
bases further allowing the computational scientist to communicate
effectively with biological and medical scientists.

## Advantages that the proposed work derives from SimpleITK/ITK

We are excited about the opportunity to port our current JF and Atropos
segmentation frameworks into the core of ITK.  Our prior experience has
shown that the quality and lifespan of such algorithms is greatly
improved when they are merged within the ITK ecosystem.  The deep
testing, consistent use of valgrind to find memory defects and
cross-platform CMake-based ctests are all integral to the further
improvement of the C++ backbone of these methods.

## How the proposed work differs from or relates to existing work in ITK and its related software

There is a substantial level-set framework within ITK.  There also
exists a relatively under utilized statistical framework that allows
methods such as k-means clustering followed by Markov random field
regularization to be implemented.  However, both of these frameworks
lack the ability to implement truly Bayesian statistical models that
incorporate spatial probability maps and maximize the posterior
probability of a segmentation map explicitly.  Consider the equation
implemented by Atropos.  **FIXME.**

## Personnel and resources to be committed to the proposed work

The personnel that will implement this plan has extensive background
working on C++.  Furthermore, the team has many decades of experience
contributing specifically to ITK.  Dr. Avants made his first commit to
ITK on Tue Apr 9 19:09:13 2002.  His most recent commit included a bug
fix on Nov 29 11:22:12 2012.  Despite his personal contributions to
code, Dr. Avants has contributed perhaps the most through his leadership
of the ITKv4 development team.  Specifically, his team implemented a
full refactoring of the ITK registration framework.  A few contributions
of this framework include thread safety, the ability to implement
composite transformations, multi-channel registration, extensibility and
addition of cutting edge diffeomorphic transformation models as well as image similarity metrics for both intensity and
point set features.  In addition, an early version of GPU-based
registration was implemented with OpenCL.  Dr. Gee was part of the
original ITK development core and was also involved in the ITKv4
registration refactoring, as PI.  He also obtained several A2D2 grants
in collaboration with Drs. Avants and Tustison.  Dr. Yushkevich began
developing with ITK in 2003 as part of the first round of
translationally focused awards which began the eminently popular
ITK-SNAP interactive segmentation software.  Dr. Yushkevich is a key
contributor to the application of ITK core tools to neuroscience goals
through his maintenance and continued development of the elegant and
easily accessible ITK-SNAP user interface, which uses ITK underneath.
Dr. Tustison has been involved in various aspects of ITK development
since he arrived at PICSL in 2004.  He was initially charged with
fulfillment of the requirements of a 2004-2005 A2D2 grant. Specifically,
he designed and coded a set of classes to handle graph data types and an
implementation of the popular ``graph cuts'' segmentation algorithm [@Tustison2008].
Other widely-used contributions include generic scattered
data approximation using B-splines [@Tustison2005], N4 bias correction
[@Tustison2009e], an RGB faux-colormapping framework [@Tustison2008c], and point set
registration [@Tustison2008a,Tustison2009b].

Dr. Avants and Dr. Tustison also promote ITK through their software
Advanced Normalization Tools (ANTs, originating at
[sourceforge.net](sourceforge.net) on 2008-06-26 and now residing at
[http://stnava.github.io/ANTs/](http://stnava.github.io/ANTs/) ).  ANTs
is a systematic framework for quantitative biological image analysis
based on the Insight ToolKit.  ANTs was first created to rapidly
disseminate our latest research to the community of scientists who
depend on imaging analytics and to allow them to study different organ
systems, species or modalities with the same sound foundation.  While
originally focused on diffeomorphic image registration, ANTs now
incorporates novel and cutting-edge methods for segmentation, feature
extraction and, more recently, complete statistical pipelines via ANTsR
[http://stnava.github.io/ANTsR/](http://stnava.github.io/ANTsR/).  In
2014, there were nearly 2,000 citations to ANTs and the software is
cloned, downloaded or otherwise accessed over 100-200 times per week, on
average at github.  The sourceforge site hosts a similar number of
visits and downloads.  ANTsR is accessed on average 50 times per
week---a substantial number for a new software.  There are also over 500
discussion topics on the ANTs sourceforge community site, nearly 100
topics on the github site and over 50 help-focused emails to the
personal addresses of developers.  Generally, response time to requests
for help is within a few hours with rare occasions taking up to a day or
two.  All of this effort magnifies the impact of ITK.

For institutional resources committed to this work, please see the
business portion of the proposal.

## Budget for the work.

We request a total of $100,000**FIXME** which includes both direct and indirect
costs.

Dr. Avants (5\%) will manage the conduct of the project and oversee the
project's successful completion of milestones and deliverables including
testing, software development and construction of tutorial material.

Dr. Yushkevich (2\%) is a co-inventor of the original Joint Label Fusion
algorithm [@Yushkevich].  Dr. Yushkevich will contribute to testing and
validating the ITK and SimpleITK implementations of JF.

Dr. Gee (2\%) has been involved in the Insight ToolKit since its
inception and will contribute his substantial registration expertise and
project management skills to the team.

Dr. Tustison (consultant) will be the lead software developer for this
project.   Dr. Tustison is among the top contributors to the Insight
ToolKit as judged by the number of lines of code from each author that
have survived and are still intact in the current revision of the
Insight ToolKit.  He is  the 11th overall contributor according to this
metric as of September 1, 2015. **FIXME** Explain why we went consulting route given your critical role

\clearpage

\newpage
